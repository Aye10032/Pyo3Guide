# å‡½æ•°ç­¾å

`#[pyfunction]` å±æ€§è¿˜æ¥å—å‚æ•°ä»¥æ§åˆ¶ç”Ÿæˆçš„ Python å‡½æ•°å¦‚ä½•æ¥å—å‚æ•°ã€‚ä¸ Python ä¸€æ ·ï¼Œå‚æ•°å¯ä»¥æ˜¯ä»…ä½ç½®å‚æ•°ã€ä»…å…³é”®å­—å‚æ•°ï¼Œæˆ–ä¸¤è€…çš†å¯ã€‚ä¹Ÿå¯ä»¥æ¥å— `*args` åˆ—è¡¨å’Œ `**kwargs` å­—å…¸ã€‚è¿™äº›å‚æ•°åŒæ ·é€‚ç”¨äº `#[pymethods]`ï¼Œå°†åœ¨æœ¬æŒ‡å—çš„ [Python ç±»](../class.md) éƒ¨åˆ†ä»‹ç»ã€‚

ä¸ Python ä¸€æ ·ï¼Œé»˜è®¤æƒ…å†µä¸‹ PyO3 å°†æ‰€æœ‰å‚æ•°è§†ä¸ºä½ç½®å‚æ•°æˆ–å…³é”®å­—å‚æ•°ã€‚å¤§å¤šæ•°å‚æ•°é»˜è®¤æ˜¯å¿…éœ€çš„ï¼Œé™¤äº†å°¾éšçš„ `Option<_>` å‚æ•°ï¼Œå®ƒä»¬æ˜¯ [éšå¼é»˜è®¤å€¼ä¸º `None`](#trailing-optional-arguments)ã€‚è¿™ç§è¡Œä¸ºå¯ä»¥é€šè¿‡ `#[pyo3(signature = (...))]` é€‰é¡¹è¿›è¡Œé…ç½®ï¼Œè¯¥é€‰é¡¹å…è®¸ä»¥ Python è¯­æ³•ç¼–å†™ç­¾åã€‚

æœ¬æŒ‡å—çš„è¿™ä¸€éƒ¨åˆ†è¯¦ç»†ä»‹ç»äº† `#[pyo3(signature = (...))]` é€‰é¡¹åŠå…¶ç›¸å…³é€‰é¡¹ `#[pyo3(text_signature = "...")]` çš„ä½¿ç”¨ã€‚

## ä½¿ç”¨ `#[pyo3(signature = (...))]`

ä¾‹å¦‚ï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªæ¥å—ä»»æ„å…³é”®å­—å‚æ•°ï¼ˆPython è¯­æ³•ä¸­çš„ `**kwargs`ï¼‰å¹¶è¿”å›ä¼ å…¥æ•°å­—çš„å‡½æ•°ï¼š

```rust
use pyo3::prelude::*;
use pyo3::types::PyDict;

#[pyfunction]
#[pyo3(signature = (**kwds))]
fn num_kwds(kwds: Option<&Bound<'_, PyDict>>) -> usize {
    kwds.map_or(0, |dict| dict.len())
}

#[pymodule]
fn module_with_functions(m: &Bound<'_, PyModule>) -> PyResult<()> {
    m.add_function(wrap_pyfunction!(num_kwds, m)?)
}
```

ä¸ Python ä¸€æ ·ï¼Œä»¥ä¸‹æ„é€ å¯ä»¥æˆä¸ºç­¾åçš„ä¸€éƒ¨åˆ†ï¼š

 * `/`ï¼šä»…ä½ç½®å‚æ•°åˆ†éš”ç¬¦ï¼Œåœ¨ `/` ä¹‹å‰å®šä¹‰çš„æ¯ä¸ªå‚æ•°éƒ½æ˜¯ä»…ä½ç½®å‚æ•°ã€‚
 * `*`ï¼šå¯å˜å‚æ•°åˆ†éš”ç¬¦ï¼Œåœ¨ `*` ä¹‹åå®šä¹‰çš„æ¯ä¸ªå‚æ•°éƒ½æ˜¯ä»…å…³é”®å­—å‚æ•°ã€‚
 * `*args`ï¼š`"args"` æ˜¯å¯å˜å‚æ•°ã€‚`args` å‚æ•°çš„ç±»å‹å¿…é¡»æ˜¯ `&Bound<'_, PyTuple>`ã€‚
 * `**kwargs`ï¼š`"kwargs"` æ¥æ”¶å…³é”®å­—å‚æ•°ã€‚`kwargs` å‚æ•°çš„ç±»å‹å¿…é¡»æ˜¯ `Option<&Bound<'_, PyDict>>`ã€‚
 * `arg=Value`ï¼šå…·æœ‰é»˜è®¤å€¼çš„å‚æ•°ã€‚
   å¦‚æœ `arg` å‚æ•°åœ¨å¯å˜å‚æ•°ä¹‹åå®šä¹‰ï¼Œåˆ™å°†å…¶è§†ä¸ºä»…å…³é”®å­—å‚æ•°ã€‚
   è¯·æ³¨æ„ï¼Œ`Value` å¿…é¡»æ˜¯æœ‰æ•ˆçš„ Rust ä»£ç ï¼ŒPyO3 åªæ˜¯å°†å…¶æ’å…¥ç”Ÿæˆçš„ä»£ç ä¸­è€Œä¸åšä¿®æ”¹ã€‚

ç¤ºä¾‹ï¼š
```rust
# use pyo3::prelude::*;
use pyo3::types::{PyDict, PyTuple};
#
# #[pyclass]
# struct MyClass {
#     num: i32,
# }
#[pymethods]
impl MyClass {
    #[new]
    #[pyo3(signature = (num=-1))]
    fn new(num: i32) -> Self {
        MyClass { num }
    }

    #[pyo3(signature = (num=10, *py_args, name="Hello", **py_kwargs))]
    fn method(
        &mut self,
        num: i32,
        py_args: &Bound<'_, PyTuple>,
        name: &str,
        py_kwargs: Option<&Bound<'_, PyDict>>,
    ) -> String {
        let num_before = self.num;
        self.num = num;
        format!(
            "num={} (was previously={}), py_args={:?}, name={}, py_kwargs={:?} ",
            num, num_before, py_args, name, py_kwargs,
        )
    }

    fn make_change(&mut self, num: i32) -> PyResult<String> {
        self.num = num;
        Ok(format!("num={}", self.num))
    }
}
```

ç±»å‹ä¸º `Python` çš„å‚æ•°ä¸å¾—æˆä¸ºç­¾åçš„ä¸€éƒ¨åˆ†ï¼š

```rust
# #![allow(dead_code)]
# use pyo3::prelude::*;
#[pyfunction]
#[pyo3(signature = (lambda))]
pub fn simple_python_bound_function(py: Python<'_>, lambda: PyObject) -> PyResult<()> {
    Ok(())
}
```

æ³¨æ„ï¼š`/` å’Œ `*` å‚æ•°çš„ä½ç½®ï¼ˆå¦‚æœåŒ…å«ï¼‰æ§åˆ¶ä½ç½®å‚æ•°å’Œå…³é”®å­—å‚æ•°çš„å¤„ç†æ–¹å¼ã€‚åœ¨ Python ä¸­ï¼š
```python
import mymodule

mc = mymodule.MyClass()
print(mc.method(44, False, "World", 666, x=44, y=55))
print(mc.method(num=-1, name="World"))
print(mc.make_change(44, False))
```
äº§ç”Ÿçš„è¾“å‡ºï¼š
```text
py_args=('World', 666), py_kwargs=Some({'x': 44, 'y': 55}), name=Hello, num=44
py_args=(), py_kwargs=None, name=World, num=-1
num=44
num=-1
```

> æ³¨æ„ï¼šè¦ä½¿ç”¨åƒ `struct` è¿™æ ·çš„å…³é”®å­—ä½œä¸ºå‡½æ•°å‚æ•°ï¼Œè¯·åœ¨ç­¾åå’Œå‡½æ•°å®šä¹‰ä¸­ä½¿ç”¨â€œåŸå§‹æ ‡è¯†ç¬¦â€è¯­æ³• `r#struct`ï¼š
>
> ```rust
> # #![allow(dead_code)]
> # use pyo3::prelude::*;
> #[pyfunction(signature = (r#struct = "foo"))]
> fn function_with_keyword(r#struct: &str) {
> #     let _ = r#struct;
>     /* ... */
> }
> ```

## å°¾éšå¯é€‰å‚æ•°

<div class="warning">

âš ï¸ è­¦å‘Šï¼šæ­¤è¡Œä¸ºæ­£åœ¨é€æ­¥æ·˜æ±° ğŸ› ï¸

å°¾éšå¯é€‰å‚æ•°çš„ç‰¹æ®Šå¤„ç†å·²è¢«å¼ƒç”¨ã€‚åœ¨æœªæ¥çš„ `pyo3` ç‰ˆæœ¬ä¸­ï¼Œç±»å‹ä¸º `Option<..>` çš„å‚æ•°å°†ä¸å…¶ä»–å‚æ•°å…±äº«ç›¸åŒçš„è¡Œä¸ºï¼Œé™¤éä½¿ç”¨ `#[pyo3(signature = (...))]` è®¾ç½®é»˜è®¤å€¼ï¼Œå¦åˆ™å®ƒä»¬æ˜¯å¿…éœ€çš„ã€‚

è¿™æ ·åšæ˜¯ä¸ºäº†æ›´å¥½åœ°å¯¹é½ Python å’Œ Rust å¯¹æ­¤ç±»å‡½æ•°çš„å®šä¹‰ï¼Œå¹¶ä½¿å…¶ä» Python é‡å†™ä¸º Rust æ›´åŠ ç›´è§‚ã€‚å…·ä½“æ¥è¯´ï¼Œ`def some_fn(a: int, b: Optional[int]): ...` ä¸ä¼šè‡ªåŠ¨å°† `b` é»˜è®¤è®¾ç½®ä¸º `none`ï¼Œè€Œæ˜¯éœ€è¦æ˜¾å¼è®¾ç½®é»˜è®¤å€¼ï¼Œè€Œåœ¨å½“å‰çš„ `pyo3` ä¸­åˆ™æ˜¯ç›¸åçš„å¤„ç†ã€‚

åœ¨è¿ç§»çª—å£æœŸé—´ï¼Œå¿…é¡»ä½¿ç”¨ `#[pyo3(signature = (...))]` æ¥æ¶ˆé™¤å¼ƒç”¨è­¦å‘Šã€‚åœ¨å®Œå…¨ç§»é™¤å¯¹å°¾éšå¯é€‰å‚æ•°çš„æ”¯æŒåï¼Œå¦‚æœæ‰€æœ‰å‚æ•°éƒ½åº”ä¸ºå¿…éœ€ï¼Œåˆ™å¯ä»¥åˆ é™¤ç­¾åå±æ€§ã€‚
</div>

ä½œä¸ºä¾¿åˆ©ï¼Œæ²¡æœ‰ `#[pyo3(signature = (...))]` é€‰é¡¹çš„å‡½æ•°å°†è§†å°¾éšçš„ `Option<T>` å‚æ•°çš„é»˜è®¤å€¼ä¸º `None`ã€‚åœ¨ä¸‹é¢çš„ç¤ºä¾‹ä¸­ï¼ŒPyO3 å°†åˆ›å»º `increment`ï¼Œå…¶ç­¾åä¸º `increment(x, amount=None)`ã€‚

```rust
#![allow(deprecated)]
use pyo3::prelude::*;

/// è¿”å› `x` å¢åŠ  `amount` çš„å‰¯æœ¬ã€‚
///
/// å¦‚æœ `amount` æœªæŒ‡å®šæˆ–ä¸º `None`ï¼Œåˆ™ç­‰åŒäº `x + 1`ã€‚
#[pyfunction]
fn increment(x: u64, amount: Option<u64>) -> u64 {
    x + amount.unwrap_or(1)
}
#
# fn main() -> PyResult<()> {
#     Python::with_gil(|py| {
#         let fun = pyo3::wrap_pyfunction!(increment, py)?;
#
#         let inspect = PyModule::import_bound(py, "inspect")?.getattr("signature")?;
#         let sig: String = inspect
#             .call1((fun,))?
#             .call_method0("__str__")?
#             .extract()?;
#
#         #[cfg(Py_3_8)]  // åœ¨ 3.7 ä¸­ç­¾åä¸ä¼šæ¸²æŸ“ bï¼Œä¸Šæ¸¸ bugï¼Ÿ
#         assert_eq!(sig, "(x, amount=None)");
#
#         Ok(())
#     })
# }
```

è¦ä½¿å°¾éšçš„ `Option<T>` å‚æ•°æˆä¸ºå¿…éœ€ï¼Œä½†ä»ç„¶æ¥å— `None`ï¼Œè¯·æ·»åŠ  `#[pyo3(signature = (...))]` æ³¨é‡Šã€‚å¯¹äºä¸Šé¢çš„ç¤ºä¾‹ï¼Œè¿™å°†æ˜¯ `#[pyo3(signature = (x, amount))]`ï¼š

```rust
# use pyo3::prelude::*;
#[pyfunction]
#[pyo3(signature = (x, amount))]
fn increment(x: u64, amount: Option<u64>) -> u64 {
    x + amount.unwrap_or(1)
}
#
# fn main() -> PyResult<()> {
#     Python::with_gil(|py| {
#         let fun = pyo3::wrap_pyfunction!(increment, py)?;
#
#         let inspect = PyModule::import_bound(py, "inspect")?.getattr("signature")?;
#         let sig: String = inspect
#             .call1((fun,))?
#             .call_method0("__str__")?
#             .extract()?;
#
#         #[cfg(Py_3_8)]  // åœ¨ 3.7 ä¸­ç­¾åä¸ä¼šæ¸²æŸ“ bï¼Œä¸Šæ¸¸ bugï¼Ÿ
#         assert_eq!(sig, "(x, amount)");
#
#         Ok(())
#     })
# }
```

ä¸ºäº†é¿å…æ··æ·†ï¼ŒPyO3 è¦æ±‚åœ¨ `Option<T>` å‚æ•°è¢«ä¸å±äº `Option<T>` çš„å‚æ•°åŒ…å›´æ—¶ä½¿ç”¨ `#[pyo3(signature = (...))]`ã€‚

## ä½¿å‡½æ•°ç­¾åå¯¹ Python å¯ç”¨

å‡½æ•°ç­¾åé€šè¿‡ `__text_signature__` å±æ€§æš´éœ²ç»™ Pythonã€‚PyO3 ä¼šè‡ªåŠ¨ä¸ºæ¯ä¸ª `#[pyfunction]` å’Œæ‰€æœ‰ç›´æ¥æ¥è‡ª Rust å‡½æ•°çš„ `#[pymethods]` ç”Ÿæˆæ­¤å†…å®¹ï¼ŒåŒæ—¶è€ƒè™‘ä½¿ç”¨ `#[pyo3(signature = (...))]` é€‰é¡¹æ‰€åšçš„ä»»ä½•è¦†ç›–ã€‚

æ­¤è‡ªåŠ¨ç”Ÿæˆåªèƒ½æ˜¾ç¤ºå­—ç¬¦ä¸²ã€æ•´æ•°ã€å¸ƒå°”ç±»å‹å’Œ `None` çš„é»˜è®¤å‚æ•°å€¼ã€‚ä»»ä½•å…¶ä»–é»˜è®¤å‚æ•°å°†æ˜¾ç¤ºä¸º `...`ã€‚ï¼ˆ`.pyi` ç±»å‹å­˜æ ¹æ–‡ä»¶é€šå¸¸ä¹Ÿä»¥ç›¸åŒæ–¹å¼ä½¿ç”¨ `...` è¡¨ç¤ºé»˜è®¤å‚æ•°ã€‚ï¼‰

åœ¨éœ€è¦è°ƒæ•´è‡ªåŠ¨ç”Ÿæˆçš„ç­¾åçš„æƒ…å†µä¸‹ï¼Œå¯ä»¥ä½¿ç”¨ `#[pyo3(text_signature)]` é€‰é¡¹ [è¦†ç›–](#overriding-the-generated-signature) ç”Ÿæˆçš„ç­¾åã€‚

ä¸‹é¢çš„ç¤ºä¾‹åˆ›å»ºäº†ä¸€ä¸ªå‡½æ•° `add`ï¼Œå®ƒæ¥å—ä¸¤ä¸ªä»…ä½ç½®å‚æ•° `a` å’Œ `b`ï¼Œå…¶ä¸­ `b` çš„é»˜è®¤å€¼ä¸ºé›¶ã€‚

```rust
use pyo3::prelude::*;

/// æ­¤å‡½æ•°å°†ä¸¤ä¸ªæ— ç¬¦å· 64 ä½æ•´æ•°ç›¸åŠ ã€‚
#[pyfunction]
#[pyo3(signature = (a, b=0, /))]
fn add(a: u64, b: u64) -> u64 {
    a + b
}
#
# fn main() -> PyResult<()> {
#     Python::with_gil(|py| {
#         let fun = pyo3::wrap_pyfunction!(add, py)?;
#
#         let doc: String = fun.getattr("__doc__")?.extract()?;
#         assert_eq!(doc, "æ­¤å‡½æ•°å°†ä¸¤ä¸ªæ— ç¬¦å· 64 ä½æ•´æ•°ç›¸åŠ ã€‚");
#
#         let inspect = PyModule::import_bound(py, "inspect")?.getattr("signature")?;
#         let sig: String = inspect
#             .call1((fun,))?
#             .call_method0("__str__")?
#             .extract()?;
#
#         #[cfg(Py_3_8)]  // åœ¨ 3.7 ä¸­ç­¾åä¸ä¼šæ¸²æŸ“ bï¼Œä¸Šæ¸¸ bugï¼Ÿ
#         assert_eq!(sig, "(a, b=0, /)");
#
#         Ok(())
#     })
# }
```

ä»¥ä¸‹ IPython è¾“å‡ºæ¼”ç¤ºäº†ä» Python å·¥å…·ä¸­å¦‚ä½•çœ‹åˆ°è¿™ä¸ªç”Ÿæˆçš„ç­¾åï¼š

```text
>>> pyo3_test.add.__text_signature__
'(a, b=..., /)'
>>> pyo3_test.add?
Signature: pyo3_test.add(a, b=0, /)
Docstring: æ­¤å‡½æ•°å°†ä¸¤ä¸ªæ— ç¬¦å· 64 ä½æ•´æ•°ç›¸åŠ ã€‚
Type:      builtin_function_or_method
```

### è¦†ç›–ç”Ÿæˆçš„ç­¾å

å¯ä»¥ä½¿ç”¨ `#[pyo3(text_signature = "(<some signature>)")]` å±æ€§æ¥è¦†ç›–é»˜è®¤ç”Ÿæˆçš„ç­¾åã€‚

åœ¨ä¸‹é¢çš„ä»£ç ç‰‡æ®µä¸­ï¼Œæ–‡æœ¬ç­¾åå±æ€§ç”¨äºåŒ…å«å‚æ•° `b` çš„é»˜è®¤å€¼ `0`ï¼Œè€Œä¸æ˜¯è‡ªåŠ¨ç”Ÿæˆçš„é»˜è®¤å€¼ `...`ï¼š

```rust
use pyo3::prelude::*;

/// æ­¤å‡½æ•°å°†ä¸¤ä¸ªæ— ç¬¦å· 64 ä½æ•´æ•°ç›¸åŠ ã€‚
#[pyfunction]
#[pyo3(signature = (a, b=0, /), text_signature = "(a, b=0, /)")]
fn add(a: u64, b: u64) -> u64 {
    a + b
}
#
# fn main() -> PyResult<()> {
#     Python::with_gil(|py| {
#         let fun = pyo3::wrap_pyfunction!(add, py)?;
#
#         let doc: String = fun.getattr("__doc__")?.extract()?;
#         assert_eq!(doc, "æ­¤å‡½æ•°å°†ä¸¤ä¸ªæ— ç¬¦å· 64 ä½æ•´æ•°ç›¸åŠ ã€‚");
#
#         let inspect = PyModule::import_bound(py, "inspect")?.getattr("signature")?;
#         let sig: String = inspect
#             .call1((fun,))?
#             .call_method0("__str__")?
#             .extract()?;
#         assert_eq!(sig, "(a, b=0, /)");
#
#         Ok(())
#     })
# }
```

PyO3 å°†ä¸åŠ ä¿®æ”¹åœ°åŒ…å«æ³¨é‡Šçš„å†…å®¹ä½œä¸º `__text_signature__`ã€‚ä¸‹é¢æ˜¾ç¤ºäº† IPython ç°åœ¨å°†å¦‚ä½•å‘ˆç°è¿™ä¸€ç‚¹ï¼ˆè¯·å‚è§ `b` çš„é»˜è®¤å€¼ä¸º 0ï¼‰ï¼š

```text
>>> pyo3_test.add.__text_signature__
'(a, b=0, /)'
>>> pyo3_test.add?
Signature: pyo3_test.add(a, b=0, /)
Docstring: æ­¤å‡½æ•°å°†ä¸¤ä¸ªæ— ç¬¦å· 64 ä½æ•´æ•°ç›¸åŠ ã€‚
Type:      builtin_function_or_method
```

å¦‚æœæ ¹æœ¬ä¸æƒ³è¦ç­¾åï¼Œå¯ä»¥ä½¿ç”¨ `#[pyo3(text_signature = None)]` æ¥ç¦ç”¨å†…ç½®ç­¾åã€‚ä¸‹é¢çš„ä»£ç ç‰‡æ®µæ¼”ç¤ºäº†è¿™ä¸€ç‚¹ï¼š

```rust
use pyo3::prelude::*;

/// æ­¤å‡½æ•°å°†ä¸¤ä¸ªæ— ç¬¦å· 64 ä½æ•´æ•°ç›¸åŠ ã€‚
#[pyfunction]
#[pyo3(signature = (a, b=0, /), text_signature = None)]
fn add(a: u64, b: u64) -> u64 {
    a + b
}
#
# fn main() -> PyResult<()> {
#     Python::with_gil(|py| {
#         let fun = pyo3::wrap_pyfunction!(add, py)?;
#
#         let doc: String = fun.getattr("__doc__")?.extract()?;
#         assert_eq!(doc, "æ­¤å‡½æ•°å°†ä¸¤ä¸ªæ— ç¬¦å· 64 ä½æ•´æ•°ç›¸åŠ ã€‚");
#         assert!(fun.getattr("__text_signature__")?.is_none());
#
#         Ok(())
#     })
# }
```

ç°åœ¨å‡½æ•°çš„ `__text_signature__` å°†è¢«è®¾ç½®ä¸º `None`ï¼ŒIPython å°†ä¸ä¼šåœ¨å¸®åŠ©ä¸­æ˜¾ç¤ºä»»ä½•ç­¾åï¼š

```text
>>> pyo3_test.add.__text_signature__ == None
True
>>> pyo3_test.add?
Docstring: æ­¤å‡½æ•°å°†ä¸¤ä¸ªæ— ç¬¦å· 64 ä½æ•´æ•°ç›¸åŠ ã€‚
Type:      builtin_function_or_method
```